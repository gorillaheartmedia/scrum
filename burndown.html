<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Burndown Waffle Chart (Daily)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background-color: #2c3e50;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .waffle-container {
      max-width: 430px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.11);
      padding: 1.5rem;
      text-align: center;
    }
    .waffle-title {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    .waffle-legend {
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }
    .waffle-grid-day {
      display: flex;
      align-items: center;
      margin-bottom: 0.6em;
    }
    .waffle-label {
      width: 78px;
      font-size: 0.92em;
      color: #888;
      text-align: right;
      margin-right: 8px;
      flex-shrink: 0;
    }
    .waffle-grid {
      display: grid;
      grid-template-columns: repeat(10, 18px);
      grid-auto-rows: 18px;
      gap: 4px;
      justify-content: start;
      margin-bottom: 0;
    }
    .waffle-block {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      background: #eee;
      display: inline-block;
      border: 1px solid #e0e0e0;
      transition: background 0.3s;
    }
    .waffle-block.done {
      background: #2ecc71;
      border: 1px solid #27ae60;
    }
    .waffle-block.todo {
      background: #fab1a0;
      border: 1px solid #e17055;
    }
    .waffle-day-percent {
      margin-left: 10px;
      font-size: 0.93em;
      color: #444;
      min-width: 38px;
      text-align: left;
    }
    .waffle-date-range {
      font-size: 0.9em;
      color: #888;
      margin-bottom: 1em;
    }
    @media (max-width: 500px) {
      .waffle-container {
        max-width: 99vw;
        padding: 0.7rem;
      }
      .waffle-label { width: 56px; font-size:0.89em; }
      .waffle-grid { grid-template-columns: repeat(7, 16px);}
    }
  </style>
</head>
<body>
  <header>
    <strong>Burndown Waffle Chart</strong>
  </header>
  <div class="waffle-container">
    <div class="waffle-title">Sprint Daily Progress</div>
    <div id="waffle-date-range" class="waffle-date-range"></div>
    <div id="waffle-legend" class="waffle-legend">
      <span style="display:inline-block;width:14px;height:14px;background:#2ecc71;border-radius:3px;vertical-align:middle;margin-right:3px;border:1px solid #27ae60;"></span> Done &nbsp;
      <span style="display:inline-block;width:14px;height:14px;background:#fab1a0;border-radius:3px;vertical-align:middle;margin-right:3px;border:1px solid #e17055;"></span> To Do
    </div>
    <div id="waffle-grid-days"></div>
    <div style="margin-top:1.5em;">
      <a href="index.html" style="text-decoration:none;color:#3498db;">⬅ Back to Scrum Board</a>
    </div>
  </div>
  <script>
    // Supabase setup
    const supabaseClient = supabase.createClient(
      'https://thiqiwptecjozwgbepvg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaXFpd3B0ZWNqb3p3Z2JlcHZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjU3NzYsImV4cCI6MjA2ODYwMTc3Nn0.-sHNcMu5YmSYwuPI4Ukae-22Nr7vGBcAXVEVDYjzG3I'
    );

// Instead of hardcoded dates, fetch from Supabase
const { data: sprints } = await supabaseClient
  .from('sprints')
  .select('*')
  .eq('team_id', currentTeamId)
  .order('start', { ascending: false })
  .limit(1);
if (sprints && sprints.length) {
  const SPRINT_START = new Date(sprints[0].start);
  const SPRINT_END = new Date(sprints[0].end);
  // Use these for chart
}


    document.addEventListener('DOMContentLoaded', async () => {
      // Auth check
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      renderDailyWaffle(session.user);
    });

    async function renderDailyWaffle(user) {
      // Fetch tasks
      const { data: tasks } = await supabaseClient
        .from('tasks')
        .select('*')
        .eq('user_id', user.id);

      // Only sprint window
      const tasksInSprint = tasks.filter(t => {
        const created = new Date(t.created_at);
        return created >= SPRINT_START && created <= SPRINT_END;
      });

      // Bucket by day
      let dayBlocks = [];
      for(let i=0; i<SPRINT_LENGTH_DAYS; i++) {
        const dayDate = new Date(SPRINT_START);
        dayDate.setDate(dayDate.getDate() + i);
        const dayLabel = dayDate.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });

        // All tasks created that day
        const tasksToday = tasksInSprint.filter(t => {
          const created = new Date(t.created_at);
          return created.getFullYear() === dayDate.getFullYear() &&
                 created.getMonth() === dayDate.getMonth() &&
                 created.getDate() === dayDate.getDate();
        });
        const total = tasksToday.length;
        const done = tasksToday.filter(t => t.status === 'done').length;
        const percent = total === 0 ? 0 : Math.round(100 * done / total);

        // Each row is up to 10 blocks wide for mobile-friendliness
        dayBlocks.push({ dayLabel, total, done, percent });
      }

      // Render rows
      const gridDays = document.getElementById('waffle-grid-days');
      gridDays.innerHTML = '';
      dayBlocks.forEach(day => {
        const row = document.createElement('div');
        row.className = 'waffle-grid-day';
        const label = document.createElement('span');
        label.className = 'waffle-label';
        label.textContent = day.dayLabel;
        row.appendChild(label);

        // Draw up to 10 blocks per row for compactness
        const waffleRow = document.createElement('div');
        waffleRow.className = 'waffle-grid';
        for (let j = 0; j < Math.min(day.total, 10); j++) {
          const block = document.createElement('div');
          block.className = 'waffle-block' + (j < day.done ? ' done' : ' todo');
          waffleRow.appendChild(block);
        }
        // Pad with empty blocks for alignment
        for (let j = day.total; j < 10; j++) {
          const block = document.createElement('div');
          block.className = 'waffle-block';
          waffleRow.appendChild(block);
        }
        row.appendChild(waffleRow);

        // Add percent label
        const percentLabel = document.createElement('span');
        percentLabel.className = 'waffle-day-percent';
        percentLabel.textContent = day.total > 0 ? `${day.percent}%` : '--';
        row.appendChild(percentLabel);

        gridDays.appendChild(row);
      });

      // Days left
      const today = new Date();
      today.setHours(0,0,0,0);
      const daysLeft = Math.max(0, Math.ceil((SPRINT_END - today) / (1000*60*60*24)));
      document.getElementById('waffle-date-range').textContent =
        `Sprint: ${SPRINT_START.toLocaleDateString()} – ${SPRINT_END.toLocaleDateString()} (${daysLeft} day${daysLeft!==1?'s':''} left)`;
    }
  </script>
</body>
</html>
