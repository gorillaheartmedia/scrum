<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scrum Board & Backlog</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 1rem;
    }
    .scrum-history {
      padding: 0.5rem 1rem;
      background-color: white;
      margin: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.07);
      font-size: 0.97rem;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .scrum-history h2 {
      margin-top: 0;
    }
    .scrum-note-entry {
      border-bottom: 1px solid #eee;
      padding: 0.5rem 0;
    }
    .scrum-note-entry:last-child {
      border-bottom: none;
    }
    .scrum-note-date {
      color: #888;
      font-size: 0.93em;
    }
    .legend, .scrum-wizard {
      padding: 0.5rem 1rem;
      background-color: white;
      margin: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }
    .legend span {
      display: inline-block;
      margin-right: 1rem;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
    }
    .legend .low { background-color: #dfe6e9; }
    .legend .medium { background-color: #ffeaa7; }
    .legend .high { background-color: #fab1a0; }

    .scrum-wizard h2 { margin-top: 0; }
    .scrum-wizard label { display: block; margin-top: 0.5rem; font-weight: bold; }
    .scrum-wizard textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    .scrum-wizard button {
      padding: 0.5rem 1rem;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .board {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      padding: 1rem;
    }
    .column {
      flex: 1;
      min-width: 250px;
      background-color: white;
      margin: 0.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .column h2 {
      margin: 0;
      padding: 1rem;
      background-color: #3498db;
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    .task-list {
      padding: 1rem;
      flex-grow: 1;
      min-height: 100px;
    }
    .task {
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .priority-1 { background-color: #dfe6e9; }
    .priority-2 { background-color: #ffeaa7; }
    .priority-3 { background-color: #fab1a0; }
    .task:hover { opacity: 0.9; }
    .stars {
      color: gold;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 0.5rem;
    }
    .add-task {
      padding: 0.5rem;
      text-align: center;
    }
    .add-task input {
      width: 80%;
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-task button {
      padding: 0.4rem 0.6rem;
      margin-left: 0.5rem;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .board { flex-direction: column; }
      header { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>
  <header>
    <span><strong>Scrum Board & Backlog</strong></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>
  <div class="legend">
    <strong>Legend:</strong>
    <span class="low">â˜…â˜†â˜† Low</span>
    <span class="medium">â˜…â˜…â˜† Medium</span>
    <span class="high">â˜…â˜…â˜… High</span>
  </div>

  <div class="scrum-wizard">
    <h2>Daily Scrum Wizard</h2>
    <label for="yesterday">What did you do yesterday?</label>
    <textarea id="yesterday" rows="3"></textarea>
    <label for="today">What will you do today?</label>
    <textarea id="today" rows="3"></textarea>
    <label for="blockers">Any blockers?</label>
    <textarea id="blockers" rows="3"></textarea>
    <button onclick="saveDailyScrum()">Save Scrum Notes</button>
  </div>

  <div class="scrum-history">
    <h2>Scrum History</h2>
    <input type="text" id="scrum-search" placeholder="Search scrum notes..." style="width:100%;padding:0.5rem;border-radius:4px;border:1px solid #ccc;margin-bottom:1rem;">
    <div id="scrum-notes-list">Loading...</div>
  </div>

  <main class="board">
    <section class="column" data-column="backlog">
      <h2>Product Backlog</h2>
      <div class="task-list" id="backlog"></div>
      <div class="add-task">
        <input type="text" placeholder="New task...">
        <button onclick="addTask('backlog')">Add</button>
      </div>
    </section>
    <section class="column" data-column="todo">
      <h2>To Do</h2>
      <div class="task-list" id="todo"></div>
      <div class="add-task">
        <input type="text" placeholder="New task...">
        <button onclick="addTask('todo')">Add</button>
      </div>
    </section>
    <section class="column" data-column="inprogress">
      <h2>In Progress</h2>
      <div class="task-list" id="inprogress"></div>
      <div class="add-task">
        <input type="text" placeholder="New task...">
        <button onclick="addTask('inprogress')">Add</button>
      </div>
    </section>
    <section class="column" data-column="done">
      <h2>Done</h2>
      <div class="task-list" id="done"></div>
      <div class="add-task">
        <input type="text" placeholder="New task...">
        <button onclick="addTask('done')">Add</button>
      </div>
    </section>
  </main>

  <script>
// --- Supabase Setup & Session Check ---
const supabase = supabase.createClient('https://thiqiwptecjozwgbepvg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoaXFpd3B0ZWNqb3p3Z2JlcHZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMjU3NzYsImV4cCI6MjA2ODYwMTc3Nn0.-sHNcMu5YmSYwuPI4Ukae-22Nr7vGBcAXVEVDYjzG3I');
let currentUser = null;
let boardData = { backlog: [], todo: [], inprogress: [], done: [] };
let allScrumNotes = [];

document.addEventListener('DOMContentLoaded', async () => {
  // Check session
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    window.location.href = 'login.html';
    return;
  }
  currentUser = session.user;
  await fetchBoardFromSupabase();
  await loadLatestScrumNote();
  await loadScrumNotesHistory();
  subscribeToTaskChanges();
  subscribeToScrumNotesChanges();
});

// --- Real-Time Subscriptions ---

function subscribeToTaskChanges() {
  supabase
    .channel('public:tasks')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'tasks', filter: `user_id=eq.${currentUser.id}` },
      payload => {
        fetchBoardFromSupabase();
      }
    )
    .subscribe();
}

function subscribeToScrumNotesChanges() {
  supabase
    .channel('public:scrum_notes')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'scrum_notes', filter: `user_id=eq.${currentUser.id}` },
      payload => {
        loadScrumNotesHistory();
        loadLatestScrumNote();
      }
    )
    .subscribe();
}

// --- Scrum Board ---
async function fetchBoardFromSupabase() {
  const { data, error } = await supabase
    .from('tasks')
    .select('*')
    .eq('user_id', currentUser.id);

  boardData = { backlog: [], todo: [], inprogress: [], done: [] };

  if (data) {
    data.forEach(task => {
      if (boardData[task.status]) boardData[task.status].push(task);
    });
    Object.keys(boardData).forEach(col => {
      boardData[col].sort((a, b) => b.priority - a.priority);
    });
  }
  renderBoard();
}

function renderBoard() {
  Object.keys(boardData).forEach(column => {
    const list = document.getElementById(column);
    list.innerHTML = '';
    boardData[column].forEach((task, index) => {
      const taskEl = document.createElement('div');
      taskEl.className = `task priority-${task.priority}`;
      taskEl.draggable = true;

      const taskText = document.createElement('span');
      taskText.textContent = task.text;
      taskText.contentEditable = true;
      taskText.addEventListener('blur', async () => {
        task.text = taskText.textContent.trim();
        await supabase.from('tasks').update({ text: task.text }).eq('id', task.id);
        fetchBoardFromSupabase();
      });

      const stars = document.createElement('span');
      stars.className = 'stars';
      stars.innerHTML = getStarsHTML(task.priority);
      stars.addEventListener('click', async e => {
        const clickedStar = [...stars.children].indexOf(e.target) + 1;
        task.priority = clickedStar;
        await supabase.from('tasks').update({ priority: clickedStar }).eq('id', task.id);
        fetchBoardFromSupabase();
      });

      const delBtn = document.createElement('button');
      delBtn.textContent = 'ðŸ—‘';
      delBtn.style.marginLeft = '8px';
      delBtn.onclick = async () => {
        await supabase.from('tasks').delete().eq('id', task.id);
        fetchBoardFromSupabase();
      };

      taskEl.appendChild(taskText);
      taskEl.appendChild(stars);
      taskEl.appendChild(delBtn);

      taskEl.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', `${column},${index}`);
      });

      list.appendChild(taskEl);
    });

    list.ondragover = e => e.preventDefault();
    list.ondrop = async e => {
      const [fromColumn, fromIndex] = e.dataTransfer.getData('text/plain').split(',');
      const task = boardData[fromColumn][fromIndex];
      await supabase.from('tasks').update({ status: column }).eq('id', task.id);
      fetchBoardFromSupabase();
    };
  });
}

function getStarsHTML(priority) {
  let html = '';
  for (let i = 1; i <= 3; i++) {
    html += `<span>${i <= priority ? 'â˜…' : 'â˜†'}</span>`;
  }
  return html;
}

async function addTask(column) {
  const input = document.querySelector(`[data-column="${column}"] input`);
  const text = input.value.trim();
  if (text) {
    await supabase.from('tasks').insert([{
      text,
      priority: 1,
      status: column,
      user_id: currentUser.id
    }]);
    input.value = '';
    fetchBoardFromSupabase();
  }
}

// --- Scrum Wizard ---

async function saveDailyScrum() {
  const yesterday = document.getElementById('yesterday').value.trim();
  const today = document.getElementById('today').value.trim();
  const blockers = document.getElementById('blockers').value.trim();

  const dateStr = new Date().toISOString().slice(0, 10);

  const { data: existing, error: fetchErr } = await supabase
    .from('scrum_notes')
    .select('id')
    .eq('user_id', currentUser.id)
    .gte('created_at', dateStr + 'T00:00:00.000Z')
    .lt('created_at', dateStr + 'T23:59:59.999Z')
    .maybeSingle();

  if (existing && existing.id) {
    await supabase
      .from('scrum_notes')
      .update({ yesterday, today, blockers })
      .eq('id', existing.id);
    alert("Today's scrum notes updated!");
  } else {
    await supabase.from('scrum_notes').insert([{
      user_id: currentUser.id,
      yesterday, today, blockers
    }]);
    alert("Today's scrum notes saved!");
  }
  await loadLatestScrumNote();
  await loadScrumNotesHistory();
}

async function loadLatestScrumNote() {
  const { data, error } = await supabase
    .from('scrum_notes')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();

  if (data) {
    document.getElementById('yesterday').value = data.yesterday || '';
    document.getElementById('today').value = data.today || '';
    document.getElementById('blockers').value = data.blockers || '';
  }
}

// --- Scrum History: load, search, and edit ---
async function loadScrumNotesHistory() {
  const notesListDiv = document.getElementById('scrum-notes-list');
  notesListDiv.textContent = 'Loading...';

  const { data, error } = await supabase
    .from('scrum_notes')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false });

  if (error) {
    notesListDiv.textContent = 'Error loading history!';
    return;
  }
  if (!data || data.length === 0) {
    notesListDiv.textContent = 'No scrum notes found.';
    return;
  }

  allScrumNotes = data; // Store for search/filter use
  renderScrumNotesList(data);
}

function renderScrumNotesList(notes) {
  const notesListDiv = document.getElementById('scrum-notes-list');
  notesListDiv.innerHTML = '';

  notes.forEach(note => {
    const entry = document.createElement('div');
    entry.className = 'scrum-note-entry';
    const date = new Date(note.created_at).toLocaleString();

    entry.innerHTML = `
      <div class="scrum-note-date">${date}</div>
      <div><strong>Yesterday:</strong> <span class="note-yesterday">${escapeHTML(note.yesterday || '-')}</span></div>
      <div><strong>Today:</strong> <span class="note-today">${escapeHTML(note.today || '-')}</span></div>
      <div><strong>Blockers:</strong> <span class="note-blockers">${escapeHTML(note.blockers || '-')}</span></div>
      <button class="edit-scrum-btn" data-id="${note.id}" style="margin-top:0.5em;">Edit</button>
    `;
    notesListDiv.appendChild(entry);
  });

  document.querySelectorAll('.edit-scrum-btn').forEach(btn => {
    btn.onclick = () => startEditScrumNote(btn.getAttribute('data-id'));
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const searchBox = document.getElementById('scrum-search');
  if (searchBox) {
    searchBox.addEventListener('input', function () {
      const q = this.value.toLowerCase();
      const filtered = allScrumNotes.filter(note =>
        (note.yesterday && note.yesterday.toLowerCase().includes(q)) ||
        (note.today && note.today.toLowerCase().includes(q)) ||
        (note.blockers && note.blockers.toLowerCase().includes(q))
      );
      renderScrumNotesList(filtered);
    });
  }
});

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, function (m) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m];
  });
}

function startEditScrumNote(noteId) {
  const note = allScrumNotes.find(n => n.id === noteId);
  if (!note) return;
  const notesListDiv = document.getElementById('scrum-notes-list');
  notesListDiv.innerHTML = '';

  // Show editable form for this note
  const entry = document.createElement('div');
  entry.className = 'scrum-note-entry';
  const date = new Date(note.created_at).toLocaleString();

  entry.innerHTML = `
    <div class="scrum-note-date">${date}</div>
    <div><strong>Yesterday:</strong><br><textarea id="edit-yesterday" rows="2" style="width:100%">${escapeHTML(note.yesterday || '')}</textarea></div>
    <div><strong>Today:</strong><br><textarea id="edit-today" rows="2" style="width:100%">${escapeHTML(note.today || '')}</textarea></div>
    <div><strong>Blockers:</strong><br><textarea id="edit-blockers" rows="2" style="width:100%">${escapeHTML(note.blockers || '')}</textarea></div>
    <button id="save-edit-btn" style="margin-top:0.7em;">Save</button>
    <button id="cancel-edit-btn" style="margin-top:0.7em;margin-left:0.7em;">Cancel</button>
  `;
  notesListDiv.appendChild(entry);

  document.getElementById('save-edit-btn').onclick = async () => {
    const updated = {
      yesterday: document.getElementById('edit-yesterday').value,
      today: document.getElementById('edit-today').value,
      blockers: document.getElementById('edit-blockers').value
    };
    await supabase.from('scrum_notes').update(updated).eq('id', noteId);
    await loadScrumNotesHistory();
  };

  document.getElementById('cancel-edit-btn').onclick = loadScrumNotesHistory;
}

async function logout() {
  await supabase.auth.signOut();
  window.location.href = 'login.html';
}


</script>
</body>
</html>
